import{createClient}from'https://esm.sh/@supabase/supabase-js@2';if(!window.SUPABASE_URL||!window.SUPABASE_ANON_KEY)console.error('[supa] Missing Supabase config');export const supabase=createClient(window.SUPABASE_URL,window.SUPABASE_ANON_KEY);export async function currentUser(){const{data:{user}}=await supabase.auth.getUser();return user||null}export async function requireUser(e='signin.html'){const t=await currentUser();if(!t){e&&(location.href=e);throw new Error('Not signed in')}return t}export async function signInOrSignUp(e,t){const{data:r,error:o}=await supabase.auth.signInWithPassword({email:e,password:t});if(!o)return{user:r.user};if(o.message&&o.message.toLowerCase().includes('invalid')){const s=await supabase.auth.signUp({email:e,password:t});return s.error?{error:s.error}:{user:s.data.user}}return{error:o}}export async function signOut(){await supabase.auth.signOut()}export async function loadProfile(){const e=await requireUser(),{data:t,error:r}=await supabase.from('profiles').select('*').eq('user_id',e.id).maybeSingle();if(r)throw r;return t||null}export async function saveProfile(e){const t=await requireUser(),r={user_id:t.id,...e,updated_at:new Date().toISOString()},{error:o}=await supabase.from('profiles').upsert(r);if(o)throw o;return!0}export async function listHistory(e=200){const t=await requireUser(),{data:r,error:o}=await supabase.from('histories').select('id,date,food,trigger,severity,notes').eq('user_id',t.id).order('date',{ascending:!1}).order('id',{ascending:!1}).limit(e);if(o)throw o;return r||[]}export async function addHistory({date:e,food:t='',trigger:r='',severity:o='',notes:s=''}){const a=await requireUser();if(!e)throw new Error('date is required (YYYY-MM-DD)');const{error:n}=await supabase.from('histories').insert([{user_id:a.id,date:e,food:t,trigger:r,severity:o,notes:s}]);if(n)throw n;return!0}