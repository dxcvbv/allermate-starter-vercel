<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Search Your Area</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Small page-local CSS to ensure a long search bar + responsive layout -->
  <style>
    .tools { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; margin: 8px 0; }
    .tools #q { width: 100%; min-width: 260px; }
    @media (max-width: 700px){ .tools { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="topbar"></div>
  <main style="max-width:1100px;margin:16px auto;padding:10px">
    <h1>Search Your Area (Mapbox)</h1>

    <div class="tools">
      <input id="q" class="input" placeholder="Type: restaurant, burger, pizza…"/>
      <button id="loc" class="button" type="button">Use my location</button>
      <button id="search" class="button" type="button">Search</button>
    </div>

    <div id="map" style="height:520px;border-radius:16px;border:1px solid #d7e8ec"></div>
  </main>

  <script>
    // Map setup
    let map = L.map('map').setView([25.2048,55.2708], 13); // Dubai fallback
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
    let layer = L.layerGroup().addTo(map);

    function add(features){
      layer.clearLayers();
      if (!features || !features.length) return;
      const bounds = [];
      features.forEach(f=>{
        const [lon,lat] = f.center || [];
        if (lat==null || lon==null) return;
        const m = L.marker([lat,lon]).addTo(layer)
          .bindPopup(`<b>${escapeHtml(f.text||'Place')}</b><br>${escapeHtml(f.place_name||'')}`);
        bounds.push([lat,lon]);
      });
      if (bounds.length) {
        const b = L.latLngBounds(bounds);
        // only fit if we moved far; keeps user zoom if already close
        if (!map.getBounds().contains(b)) map.fitBounds(b.pad(0.2));
      }
    }

    async function search(){
      const c = map.getCenter();
      const q = document.getElementById('q').value.trim() || 'restaurant';

      // include visible map bounds to focus results
      const b = map.getBounds();
      const bbox = `${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()}`;

      try{
        const r = await fetch(`/api/places?lat=${c.lat}&lng=${c.lng}&q=${encodeURIComponent(q)}&bbox=${encodeURIComponent(bbox)}`);
        const data = await r.json();
        if (data.error) { alert('API error: ' + data.error); console.error(data); return; }
        add(data.places);
        if (!data.places || data.places.length === 0) {
          alert('No places found. Zoom out a bit or try another keyword (burger, pizza, cafe, shawarma, etc.).');
        }
      }catch(err){
        alert('Network error calling /api/places');
        console.error(err);
      }
    }

    document.getElementById('search').onclick = search;

    // Enter-to-search
    document.getElementById('q').addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); search(); }
    });

    // Use my location — tighter zoom + a pin
    document.getElementById('loc').onclick = ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const { latitude, longitude } = pos.coords;
          L.marker([latitude, longitude]).addTo(layer).bindPopup('You are here').openPopup();
          map.setView([latitude, longitude], 16);
          search();
        },
        err=>{
          alert('Location blocked. Pan/zoom to your area, then press Search.');
          console.warn(err);
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    };

    // initial search near default center
    search();

    // tiny helper to avoid HTML issues in popups
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
